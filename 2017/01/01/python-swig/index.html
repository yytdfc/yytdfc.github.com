<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> macOS下使用SWIG完成Python调用C/C++接口 · Votec</title><meta name="description" content="macOS下使用SWIG完成Python调用C/C++接口 - ChenFu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://votec.top/atom.xml" title="Votec"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="https://github.com/yytdfc" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">macOS下使用SWIG完成Python调用C/C++接口</h1><div class="post-info">Jan 1, 2017<full_date item.date ll>&#8853 <span id="busuanzi_container_page_pv">Viewed<span id="busuanzi_value_page_pv"></span> times</span></full_date></div><div class="post-content"><blockquote>
<p><a href="http://swig.org/translations/chinese/index.html" target="_blank" rel="external">SWIG</a>是个帮助使用C或者C++编写的软件能与其它各种高级编程语言进行嵌入联接的开发工具。SWIG能应用于各种不同类型的语言包括常用脚本编译语言例如Perl, PHP, Python, Tcl, Ruby and PHP。</p>
</blockquote>
<p>其中关于mac下的一些特殊用法参考了这个<a href="https://segmentfault.com/a/1190000003948295" target="_blank" rel="external">blog</a>。<br><a id="more"></a></p>
<h2 id="1-首先写一个最简单的C程序："><a href="#1-首先写一个最简单的C程序：" class="headerlink" title="1. 首先写一个最简单的C程序："></a>1. 首先写一个最简单的C程序：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</div><div class="line">  <span class="keyword">return</span> a+b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-再写一个Swig接口文件："><a href="#2-再写一个Swig接口文件：" class="headerlink" title="2. 再写一个Swig接口文件："></a>2. 再写一个Swig接口文件：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//func.i</div><div class="line">%module func</div><div class="line">%&#123;</div><div class="line">  extern int add(int, int);</div><div class="line">%&#125;</div><div class="line">extern int add(int, int);</div></pre></td></tr></table></figure>
<h2 id="3-编译func-c得到目标文件func-o："><a href="#3-编译func-c得到目标文件func-o：" class="headerlink" title="3. 编译func.c得到目标文件func.o："></a>3. 编译func.c得到目标文件func.o：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -c -fpic func.c</div></pre></td></tr></table></figure>
<h2 id="4-由接口文件func-i生成func-wrap-c和func-py："><a href="#4-由接口文件func-i生成func-wrap-c和func-py：" class="headerlink" title="4. 由接口文件func.i生成func_wrap.c和func.py："></a>4. 由接口文件func.i生成func_wrap.c和func.py：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">swig -python func.i</div></pre></td></tr></table></figure>
<p>如果是C++，记得加上<code>-c++</code>参数。</p>
<h2 id="5-编译接口："><a href="#5-编译接口：" class="headerlink" title="5. 编译接口："></a>5. 编译接口：</h2><p>编译需要用到<code>Python.h</code>头文件，那么在macOS下的<code>Python.h</code>文件在哪呢，具体跟macOS和Xcode版本有关，以<em>MacOSX10.12</em>为例，具体路径在<code>/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.12.sdk/System/Library/Frameworks/Python.framework/Versions/2.7/include/python2.7</code>。</p>
<p>为了以后使用方便，加一个链接到系统include目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ln -s /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.12.sdk/System/Library/Frameworks/Python.framework/Versions/2.7/include/python2.7 /usr/<span class="built_in">local</span>/include/python2.7</div></pre></td></tr></table></figure>
<p>然后编译接口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -c -fpic func_wrap.c -I/usr/include/python2.7</div></pre></td></tr></table></figure>
<h2 id="6-链接目标文件，生成-func-so："><a href="#6-链接目标文件，生成-func-so：" class="headerlink" title="6. 链接目标文件，生成_func.so："></a>6. 链接目标文件，生成_func.so：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -shared -lpython2.7 func.o func_wrap.o -o _func.so</div></pre></td></tr></table></figure>
<p>注意这里需要指定链接的Python版本，用<code>-lpython2.7</code>参数。</p>
<h2 id="7-最后在在python中import测试："><a href="#7-最后在在python中import测试：" class="headerlink" title="7. 最后在在python中import测试："></a>7. 最后在在python中import测试：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> func</div><div class="line">print(func.add(<span class="number">2</span>,<span class="number">7</span>))</div></pre></td></tr></table></figure>
<p>这时候会出现一个强力的bug：<code>Fatal Python error: PyThreadState_Get: no current thread</code>，经过不断查找与测试，最终发现是因为brew安装的python出的差错（<a href="http://stackoverflow.com/questions/15678153/homebrew-python-on-mac-os-x-10-8-fatal-python-error-pythreadstate-get-no-cu" target="_blank" rel="external">看这里</a>，即使用自带的头文件编译一样没有用，真是好坑，先后被brew的python 2.7和3.5都坑过了，还是<code>brew remove python</code>卸掉比较安全放心。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/01/31/macOS-reinstall/" class="prev">Prev</a><a href="/2017/01/01/python-pip-note/" class="next">Next</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {url: document.location.href,sourceId: "2017/01/01/python-swig/",productKey: "b710aea8146b4b82be4291d960552145",target: "cloud-tie-wrapper"};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script><div class="copyright"><p>© 2016~2017 <a href="http://votec.top">ChenFu</a>  &#8225  Site viewed <span id="busuanzi_value_site_pv"></span> times.</span></p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> + <a href="https://github.com/yytdfc/hexo-theme-apollo-plus" target="_blank">apollo</a> <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv"></p></div></footer></div><script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script><script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-100648993-1','auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?3a1457089b82f026e9a39fbe773531ff";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();</script><script type="text/javascript" src="http://tajs.qq.com/stats?sId=59104549" charset="UTF-8"></script></body></html>